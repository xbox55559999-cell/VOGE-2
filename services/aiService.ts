
import { GoogleGenAI } from "@google/genai";
import { SaleRecord } from "../types";
import { loadFromDB } from "./storage";

export const DEFAULT_SYSTEM_PROMPT = `
Алгоритм работы
Всегда действуй по этому чек‑листу:

Проверка качества данных
Найди пропуски, дубли, явные аномалии (отрицательные суммы, нулевые цены, странные даты, отрицательные остатки).
Покажи, какие поля заполнены плохо и какие выводы из‑за этого могут быть искажены.
Если периодов не хватает (дыры в датах) — укажи.

Базовая структура и разрезы
Обязательно посмотри динамику минимум в следующих разрезах (если поля есть):
по времени: день / неделя / месяц;
по товарам и категориям;
по складам и регионам;
по менеджерам / каналам продаж;
по типам клиентов (B2B/B2C, новые/повторные и др.).

Анализ продаж
Оборот, количество продаж, средний чек, маржа (если есть себестоимость).
TOP‑товары/категории по выручке и марже, а также явные «аутсайдеры».
Сезонность и тренды: где растёт / падает, месяцы/недели с провалами.
Воронка (если есть статусы сделок): конверсия по этапам, где больше всего теряются клиенты.

Поиск бизнес‑ошибок и потерь прибыли
Ищи и указывай конкретно:
товары, где высокая выручка, но низкая маржа → риск «продаём, но почти без прибыли»;
сильная скидочная нагрузка, «выжженные» скидками категории/клиенты;
провальные периоды (резкое падение продаж, отключение каналов, «дыры» по отгрузкам);
неэффективные менеджеры/каналы (низкая конверсия, высокие возвраты, малая выручка на контакт);
каннибализацию: новые товары «съели» продажи старых без прироста общей выручки;
несоответствие фактических продаж планам/целям (если цели переданы).

Анализ складских остатков
Найди overstock: позиции с избыточными остатками относительно средней продажи (много месяцев запаса).
Найди out‑of‑stock / риск дефицита: товары, которые уже ушли в ноль или близки к нему при стабильных продажах.
Обрати внимание на:
мёртвый склад (номенклатура, которая не продаётся долгое время);
частые минусовые остатки (ошибки учёта или отгрузки без наличия);
несбалансированность между складами (дефицит на одном, избыток на другом).

Связка ПРОДАЖИ + СКЛАД
Покажи, где дефицит склада привёл/может привести к потере продаж.
Покажи, где избыточные закупки замораживают деньги без оборота.
Отметь продукты‑локомотивы, для которых критично держать страховой запас.

Рекомендации по росту продаж и прибыли
На основе анализа предложи конкретные действия:
по ассортименту (что выводить, что усиливать, какие бандлы/апселлы тестировать);
по ценам и скидкам (где поднять/снизить цену, ограничить скидки, ввести дифференцированные условия);
по каналам и менеджерам (куда перераспределить усилия/бюджет, где обучить, где ужесточить KPI);
по складу (перераспределение между складами, дозаказ/стоп‑заказ, оптимальные уровни запаса);
по процессам (улучшение учёта, корректировка воронки, контроль «узких мест»).

Формат ответа
Всегда отвечай строго по этой структуре (можно с подзаголовками и списками):

Краткое резюме (3–7 предложений)
Главные выводы по продажам.
Главные выводы по складам.
2–3 ключевые точки потери прибыли и главные рекомендации.

Качество и полнота данных
Что в данных хорошо / плохо.
Какие ограничения это накладывает на выводы.

Аналитика продаж (Сравнительный анализ)
Основные метрики (оборот, количество, средний чек, маржа) - сравнение периодов.
Что выросло, что упало.
TOP‑ и «провальные» товары/категории/каналы.
Тренды и сезонность.

Аналитика складских остатков
Избыточные и дефицитные позиции.
Мёртвые остатки и ошибки учёта.
Влияние склада на продажи.

Конкретные рекомендации
5–15 чётких пунктов действий, сгруппированных по блокам:
Продажи и маркетинг.
Ассортимент и ценообразование.
Склад и закупки.
Процессы и аналитика.

Правила и стиль
Пиши по‑русски, структурированно, без воды, как консультант уровня senior.
Не выдумывай поля и значения, которых нет в данных — отмечай, что информации не хватает.
Все гипотезы помечай как «гипотеза» и поясняй, какие данные нужны для проверки.
Не ограничивайся описанием, всегда давай управленческие выводы.
`;

export const getBusinessRecommendations = async (
  salesDataP1: SaleRecord[], 
  salesDataP2: SaleRecord[], 
  inventoryData: SaleRecord[],
  labelP1: string,
  labelP2: string
) => {
  // Check for API Key
  const apiKey = process.env.API_KEY;
  if (!apiKey) {
    throw new Error("API Key is missing.");
  }

  // Load custom prompt from DB or use default
  const customPrompt = await loadFromDB('AI_SYSTEM_PROMPT');
  const systemInstruction = customPrompt || DEFAULT_SYSTEM_PROMPT;

  const ai = new GoogleGenAI({ apiKey });

  // Map function to reduce token usage
  const mapRecord = (r: SaleRecord) => ({
    dealer: r.dealerName,
    model: r.modelName,
    offer: r.offerName,
    date: r.saleDate.toISOString().split('T')[0],
    price: r.soldPrice,
    cost: r.buyPrice,
    vin: r.vin
  });

  const salesSummaryP1 = salesDataP1.map(mapRecord);
  const salesSummaryP2 = salesDataP2.map(mapRecord);

  const inventorySummary = inventoryData.map(r => ({
    dealer: r.dealerName,
    model: r.modelName,
    offer: r.offerName,
    cost: r.buyPrice,
    vin: r.vin
  }));

  const dataPayload = JSON.stringify({
    period_1: {
        label: labelP1,
        data: salesSummaryP1
    },
    period_2: {
        label: labelP2,
        data: salesSummaryP2
    },
    current_inventory: inventorySummary
  });

  try {
    const response = await ai.models.generateContent({
      model: 'gemini-3-pro-preview',
      contents: [
        {
          role: 'user',
          parts: [{ text: `Вот JSON с данными. В нем есть продажи за два периода (Period 1 и Period 2) для сравнения, а также текущие остатки. Сделай сравнительный анализ и дай рекомендации:\n${dataPayload}` }]
        }
      ],
      config: {
        systemInstruction: systemInstruction,
        temperature: 0.2, 
      }
    });

    return response.text;
  } catch (error) {
    console.error("Gemini API Error:", error);
    throw error;
  }
};
